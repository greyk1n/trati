<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Учёт расходов</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">
  <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-2xl">
    <h1 class="text-2xl font-bold mb-4 text-center">Учёт расходов</h1>

    <!-- Форма добавления -->
    <div class="mb-6">
      <input id="date" type="date" class="border p-2 rounded w-full mb-2">

      <select id="category" class="border p-2 rounded w-full mb-2">
        <option value="Еда">Еда</option>
        <option value="Транспорт">Транспорт</option>
        <option value="Развлечения">Развлечения</option>
        <option value="Здоровье">Здоровье</option>
        <option value="Покупки">Покупки</option>
        <option value="Прочее">Прочее</option>
      </select>

      <input id="amount" type="number" placeholder="Сумма" class="border p-2 rounded w-full mb-2">
      <input id="comment" type="text" placeholder="Комментарий" class="border p-2 rounded w-full mb-2">
      <button onclick="addExpense()" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Добавить</button>
    </div>

    <!-- Список расходов -->
    <h2 class="text-xl font-semibold mb-2">Список расходов</h2>
    <ul id="list" class="space-y-2"></ul>

  </div>

  <script>
    const list = document.getElementById("list");
    let expenses = [];

    async function loadExpenses() {
      const response = await fetch("save.php");
      expenses = await response.json();
      renderExpenses();
    }

    async function saveToServer(action, expense = null, index = null) {
      const response = await fetch("save.php", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ action, expense, index })
      });
      return response.json();
    }

    function renderExpenses() {
      list.innerHTML = "";
      expenses.forEach((e, index) => {
        const li = document.createElement("li");
        li.className = "p-3 bg-gray-50 rounded shadow flex justify-between items-center";
        li.innerHTML = `
          <span>${e.date} | ${e.category} | ${e.amount} руб | ${e.comment}</span>
          <button onclick="deleteExpense(${index})" class="text-red-500">Удалить</button>
        `;
        list.appendChild(li);
      });
    }

    async function addExpense() {
      const date = document.getElementById("date").value;
      const category = document.getElementById("category").value;
      const amount = document.getElementById("amount").value;
      const comment = document.getElementById("comment").value;

      if (!date || !category || !amount) return;

      expenses = await saveToServer("add", { date, category, amount, comment });
      renderExpenses();

      document.getElementById("amount").value = "";
      document.getElementById("comment").value = "";
    }

    async function deleteExpense(index) {
      expenses = await saveToServer("delete", null, index);
      renderExpenses();
    }

    loadExpenses();
  </script>
</body>
</html>

<!-- save.php -->
<?php
header('Content-Type: application/json; charset=utf-8');

$file = "expenses.json";

if (file_exists($file)) {
    $data = json_decode(file_get_contents($file), true);
} else {
    $data = [];
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $input = json_decode(file_get_contents("php://input"), true);
    if ($input && isset($input["action"])) {
        if ($input["action"] === "add") {
            $data[] = $input["expense"];
        } elseif ($input["action"] === "delete") {
            unset($data[$input["index"]]);
            $data = array_values($data);
        }
        file_put_contents($file, json_encode($data, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
    }
}

echo json_encode($data, JSON_UNESCAPED_UNICODE);
?>
